<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mapa de Pontos de Poda</title>

  <!-- Leaflet + MarkerCluster CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />

  <style>
    html, body { margin: 0; padding: 0; height: 100%; font-family: Arial, sans-serif; }
    #map { height: 100%; width: 100%; }

    .loc-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
      background: #007bff;
      color: #fff;
      padding: 14px 18px;
      border-radius: 50px;
      font-weight: bold;
      cursor: pointer;
    }

    .legend {
      position: fixed;
      bottom: 80px;
      right: 20px;
      background: #fff;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,.3);
      z-index: 999;
      font-size: 14px;
    }

    /* ===== MODAL ===== */
    #modalExecucao {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.5);
      z-index: 2000;
      backdrop-filter: blur(5px);
    }

    #modalExecucao .box {
      background: #fff;
      width: 320px;
      margin: 100px auto;
      padding: 20px;
      border-radius: 12px;
    }

    #modalExecucao input,
    #modalExecucao textarea {
      width: 100%;
      margin-bottom: 10px;
    }
  </style>
</head>

<body>
<div id="map"></div>
<div class="loc-btn" onclick="goToLocation()">üìç Localizar</div>

<div class="legend">
  <strong>Legenda</strong><br>
  <input type="checkbox" id="chkBT" checked> Poda BT<br>
  <input type="checkbox" id="chkMT" checked> Poda MT<br>
  <input type="checkbox" id="chkTI" checked> Trocar Isolador
</div>

<!-- ===== MODAL EXECU√á√ÉO ===== -->
<div id="modalExecucao">
  <div class="box">
    <h3>Executar ponto</h3>

    <label for="inputEquipe">Equipe *</label> <br>
    <select id="inputEquipe" style="box-shadow: none; border: 1px solid black; background-color: white;">
      <option value="CSRPNA0601">CSRPNA0601</option>
      <option value="CSRSJM0602">CSRSJM0602</option>
      <option value="CSRPNA0603">CSRPNA0603</option>
      <option value="CSRPNA0701">CSRPNA0701</option>
      <option value="CSRPNA0702">CSRPNA0702</option>
      <option value="CSRPNA0703">CSRPNA0703</option>
      <option value="CSRPNA0704">CSRPNA0704</option>
      <option value="CSRPNA0801">CSRPNA0801</option>
      <option value="CSRPNA0802">CSRPNA0802</option>
      <option value="CSRPNA1301">CSRPNA1301</option>
      <option value="CSRPNA1501">CSRPNA1501</option>
      <option value="CSRPNA1502">CSRPNA1502</option>
      <option value="CSRSJM1503">CSRSJM1503</option>
      <option value="CSRPNA1504">CSRPNA1504</option>
    </select>
    <br> <br>

    <label>Data *</label>
    <input id="inputData" type="date">

    <label>Descri√ß√£o</label>
    <textarea id="inputDescricao" rows="3"></textarea>

    <div style="text-align:right">
      <button onclick="fecharModal()" style="background:red;color:#fff;border:none;padding:6px 12px;border-radius:4px">Cancelar</button>
      <button onclick="confirmarExecucao()" style="background:#28a745;color:#fff;border:none;padding:6px 12px;border-radius:4px">
        Confirmar
      </button>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

<script>
/* ===== UTIL ===== */
const normalize = s => String(s||'').normalize('NFD').replace(/[ÃÄ-ÕØ]/g,'').toLowerCase()
const toFloat = v => { const n = parseFloat(String(v).replace(',','.')); return isNaN(n)?null:n }

/* ===== MAPA ===== */
const map = L.map('map').setView([-5.9,-35.29],12)
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map)

const icons = {
  green: L.icon({iconUrl:'https://maps.google.com/mapfiles/ms/icons/green-dot.png',iconSize:[32,32]}),
  red: L.icon({iconUrl:'https://maps.google.com/mapfiles/ms/icons/red-dot.png',iconSize:[32,32]}),
  blue: L.icon({iconUrl:'https://maps.google.com/mapfiles/ms/icons/blue-dot.png',iconSize:[32,32]}),
  user: L.icon({iconUrl:'https://cdn-icons-png.flaticon.com/512/684/684908.png',iconSize:[32,32]})
}

const markers = L.markerClusterGroup()
map.addLayer(markers)

const btMarkers=[], mtMarkers=[], tiMarkers=[]
let pontoSelecionadoId = null

/* ===== CARREGAR PONTOS ===== */
fetch('https://mapa-pontos-poda.onrender.com/pontos/listar_ativos')
  .then(r=>r.json())
  .then(data=>{
    data.forEach(row=>{
      const lat = toFloat(row.latitude)
      const lon = toFloat(row.longitude)
      if(!lat||!lon) return

      const s = normalize(row.servico)
      let icon, arr
      if(s.includes('poda de bt')){icon=icons.green;arr=btMarkers}
      else if(s.includes('poda de mt')){icon=icons.red;arr=mtMarkers}
      else if(s.includes('trocar isolador')){icon=icons.blue;arr=tiMarkers}
      else return

      const marker = L.marker([lat,lon],{icon})
        .bindPopup(`
          <b>OI:</b> ${row.numero_oi}<br>
          <b>Barramento:</b> ${row.barramento}<br>
          <b>Servi√ßo:</b> ${row.servico}<br><br>
          <button onclick="abrirModal(${row.id})" style="
        background-color:#28a745;
        color:#fff;
        border:none;
        border-radius:6px;
        padding:8px 14px;
        font-size:14px;
        font-weight:600;
        cursor:pointer;
        width:100%;"
        >Executar</button>
        `)

      arr.push(marker)
      markers.addLayer(marker)
    })
  })

/* ===== FILTROS ===== */
const update = (arr,show)=>arr.forEach(m=>show?markers.addLayer(m):markers.removeLayer(m))
chkBT.onchange=e=>update(btMarkers,e.target.checked)
chkMT.onchange=e=>update(mtMarkers,e.target.checked)
chkTI.onchange=e=>update(tiMarkers,e.target.checked)

/* ===== MODAL ===== */
function abrirModal(id){
  pontoSelecionadoId=id
  inputEquipe.value=''
  inputData.value=''
  inputDescricao.value=''
  modalExecucao.style.display='block'
}

function fecharModal(){
  modalExecucao.style.display='none'
  pontoSelecionadoId=null
}

/* ===== CONFIRMAR EXECU√á√ÉO ===== */
function confirmarExecucao(){
  const equipe=inputEquipe.value.trim()
  const data=inputData.value

  if(!equipe || !data){
    alert('Equipe e data s√£o obrigat√≥rios')
    return
  }

  fetch(`https://mapa-pontos-poda.onrender.com/pontos/mudar_status/${pontoSelecionadoId}`,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({
      equipe,
      data_execucao: data,
      descricao: inputDescricao.value,
      id_ponto: pontoSelecionadoId,
    })
  })
  .then(r=>{
    if(!r.ok) throw 'erro'
    markers.eachLayer(m=>{
      if(m.getPopup()?.getContent().includes(`abrirModal(${pontoSelecionadoId})`)){
        markers.removeLayer(m)
      }
    })
    fecharModal()
  })
  .catch(()=>alert('Erro ao executar ponto'))
}

/* ===== GEOLOCALIZA√á√ÉO ===== */
let userLat,userLon,userMarker
navigator.geolocation?.getCurrentPosition(p=>{
  userLat=p.coords.latitude
  userLon=p.coords.longitude
  userMarker=L.marker([userLat,userLon],{icon:icons.user}).addTo(map)
})

function goToLocation(){
  if(userLat&&userLon){
    map.setView([userLat,userLon],16)
  }
}
</script>
</body>
</html>
